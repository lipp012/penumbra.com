<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FICHA OPERACIONAL // AGENTE</title>
  <style>
    /* --- VARIÁVEIS DE TEMA (As mesmas do arquivo anterior para consistência) --- */
    :root {
      --bg-color: #050505;
      --panel-bg: #0e0e0e;
      --primary: #00ff66;       /* Verde */
      --secondary: #00ccff;     /* Azul */
      --accent: #ffcc00;        /* Amarelo */
      --danger: #ff0033;        /* Vermelho */
      --text: #e0e0e0;
      --text-muted: #888;
      --border-radius: 4px;
      --font-mono: "Courier New", monospace;
    }

    * { box-sizing: border-box; }

    body {
      background-color: #000;
      color: var(--primary);
      font-family: var(--font-mono);
      margin: 0;
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
    }

    /* --- LAYOUT PRINCIPAL --- */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding-bottom: 50px;
    }

    header {
      border-bottom: 2px solid var(--primary);
      margin-bottom: 20px;
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
    h2 { font-size: 1.1rem; color: var(--secondary); border-bottom: 1px solid #333; margin-top: 25px; margin-bottom: 10px; padding-bottom: 5px; text-transform: uppercase; }
    h3 { font-size: 0.9rem; color: var(--text-muted); margin: 10px 0 5px 0; text-transform: uppercase; }

    /* --- INPUTS E CAMPOS --- */
    input, textarea, select {
      background: #111;
      border: 1px solid #333;
      color: var(--text);
      font-family: var(--font-mono);
      padding: 8px;
      width: 100%;
      transition: border 0.3s, box-shadow 0.3s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 5px rgba(0, 255, 102, 0.2);
    }

    input[readonly] { background: #080808; color: var(--text-muted); border-style: dashed; cursor: default; }
    textarea { resize: vertical; min-height: 60px; }

    /* --- GRID SYSTEM --- */
    .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 200px; }
    .col-small { flex: 0 0 100px; }

    /* --- INFO BOX --- */
    .identity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      background: var(--panel-bg);
      padding: 15px;
      border: 1px solid #333;
    }

    /* --- ATRIBUTOS E STATUS --- */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .stat-panel {
      background: var(--panel-bg);
      border: 1px solid #333;
      padding: 15px;
    }

    .attr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .attr-box { text-align: center; }
    .attr-box label { display: block; font-size: 0.8rem; color: var(--secondary); margin-bottom: 4px; }
    .attr-box input { text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--primary); }

    /* STATUS BARS (Vida, Sanidade, etc) */
    .resource-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      background: #000;
      padding: 5px;
      border: 1px solid #222;
    }
    .resource-label { width: 80px; font-weight: bold; font-size: 0.9rem; }
    .resource-val { width: 60px; text-align: center; color: #fff; font-weight: bold; }
    .resource-max { color: #666; font-size: 0.8rem; }
    
    .btn-adjust {
      width: 25px; height: 25px;
      display: flex; align-items: center; justify-content: center;
      background: #222; border: 1px solid #444; color: #fff;
      cursor: pointer; user-select: none;
    }
    .btn-adjust:hover { background: #444; }
    .btn-adjust.minus { color: var(--danger); }
    .btn-adjust.plus { color: var(--primary); }

    /* --- PERÍCIAS --- */
    .skills-list {
      column-count: 2;
      column-gap: 20px;
      font-size: 0.85rem;
    }
    .skill-tag {
      display: inline-block;
      margin-bottom: 4px;
      width: 100%;
      padding: 4px;
      border-bottom: 1px solid #222;
    }
    .skill-tag strong { color: var(--text); }
    .skill-origin { color: var(--accent); font-size: 0.75em; margin-left: 5px; }

    /* --- MODAL --- */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(2px);
    }
    .modal-content {
      background-color: var(--panel-bg);
      margin: 5% auto;
      padding: 20px;
      border: 1px solid var(--secondary);
      width: 90%; max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0, 204, 255, 0.2);
    }
    .close-modal { float: right; font-size: 1.5rem; cursor: pointer; color: var(--danger); }

    /* --- ACTIONS --- */
    .toolbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.9);
      border-top: 1px solid var(--primary);
      padding: 10px;
      display: flex; justify-content: center; gap: 10px;
      flex-wrap: wrap;
      backdrop-filter: blur(5px);
    }

    button {
      background: transparent;
      color: var(--secondary);
      border: 1px solid var(--secondary);
      padding: 8px 16px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-weight: bold;
      text-transform: uppercase;
      transition: all 0.2s;
    }
    button:hover { background: var(--secondary); color: #000; }
    button.btn-primary { color: var(--primary); border-color: var(--primary); }
    button.btn-primary:hover { background: var(--primary); color: #000; }
    button.btn-danger { color: var(--danger); border-color: var(--danger); }
    button.btn-danger:hover { background: var(--danger); color: #fff; }

    /* Toast Notification */
    #toast {
      visibility: hidden; min-width: 250px;
      background-color: #333; color: #fff; text-align: center;
      border-radius: 2px; padding: 16px; position: fixed; z-index: 2000;
      left: 50%; bottom: 80px; transform: translateX(-50%);
      font-size: 17px; border: 1px solid var(--primary);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

    @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
    
    @media (max-width: 700px) {
      .skills-list { column-count: 1; }
      .toolbar { position: static; margin-top: 20px; }
      .container { padding-bottom: 10px; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Ficha Operacional</h1>
    <div style="font-size: 0.8rem; color: var(--text-muted);">
      STATUS: <span style="color:var(--primary)">ATIVO</span>
    </div>
  </header>

  <section class="identity-grid">
    <div>
      <label style="color:var(--secondary)">Nome</label>
      <input id="nome" type="text">
    </div>
    <div>
      <label style="color:var(--secondary)">Origem</label>
      <input id="origem" type="text" readonly>
    </div>
    <div>
      <label style="color:var(--secondary)">Classe</label>
      <input id="classe" type="text" readonly>
    </div>
    <div>
      <label style="color:var(--secondary)">Nível</label>
      <input id="nivel" type="number" min="1" max="99" style="width: 60px; color:var(--accent);">
    </div>
  </section>

  <div style="margin-top: 10px;">
    <textarea id="descricao" placeholder="Descrição e anotações rápidas..." style="height: 40px;"></textarea>
  </div>

  <div class="stats-container" style="margin-top: 20px;">
    
    <div class="stat-panel">
      <h2>Condição Atual</h2>
      
      <div class="resource-row">
        <span class="resource-label" style="color:#ff6666">VIDA</span>
        <button class="btn-adjust minus" onclick="App.adjustStat('vidaAtual', -1)">-</button>
        <input id="vidaAtual" class="resource-val" value="0">
        <button class="btn-adjust plus" onclick="App.adjustStat('vidaAtual', 1)">+</button>
        <span class="resource-max">/ <span id="vidaMaxDisplay">0</span> Max</span>
      </div>

      <div class="resource-row">
        <span class="resource-label" style="color:#6699ff">SANIDADE</span>
        <button class="btn-adjust minus" onclick="App.adjustStat('sanidadeAtual', -1)">-</button>
        <input id="sanidadeAtual" class="resource-val" value="0">
        <button class="btn-adjust plus" onclick="App.adjustStat('sanidadeAtual', 1)">+</button>
        <span class="resource-max">/ <span id="sanidadeMaxDisplay">0</span> Max</span>
      </div>

      <div class="resource-row">
        <span class="resource-label" style="color:#66ff66">ESFORÇO</span>
        <button class="btn-adjust minus" onclick="App.adjustStat('esforcoAtual', -1)">-</button>
        <input id="esforcoAtual" class="resource-val" value="0">
        <button class="btn-adjust plus" onclick="App.adjustStat('esforcoAtual', 1)">+</button>
        <span class="resource-max">/ <span id="esforcoMaxDisplay">0</span> Max</span>
      </div>

      <div style="margin-top:15px; border-top:1px dashed #333; padding-top:10px;">
        <label style="font-size:0.8rem; color:var(--accent)">Iluminação (Nex %)</label>
        <input id="iluminacao" type="number" readonly style="color:var(--accent); width: 80px;">
      </div>
    </div>

    <div class="stat-panel">
      <h2>Atributos Base</h2>
      <div class="attr-grid">
        <div class="attr-box">
          <label>FOR</label>
          <input type="number" id="forca" onchange="App.recalc()">
        </div>
        <div class="attr-box">
          <label>RES</label>
          <input type="number" id="resistencia" onchange="App.recalc()">
        </div>
        <div class="attr-box">
          <label>CAR</label>
          <input type="number" id="carisma" onchange="App.recalc()">
        </div>
        <div class="attr-box">
          <label>IDE</label>
          <input type="number" id="ideia" onchange="App.recalc()">
        </div>
        <div class="attr-box">
          <label>DES</label>
          <input type="number" id="destreza" onchange="App.recalc()">
        </div>
        <div class="attr-box">
          <label>CON</label>
          <input type="number" id="conexao" onchange="App.recalc()">
        </div>
      </div>
      
      <div style="margin-top: 15px; font-size: 0.75rem; color: #666; font-style: italic;">
        * Alterar atributos recalcula a Vida/San Máxima automaticamente.
      </div>
    </div>
  </div>

  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px;">
    <h2>Perícias Treinadas</h2>
    <button onclick="App.openModal()" style="font-size: 0.8rem; padding: 4px 8px;">Editar</button>
  </div>
  
  <div class="stat-panel" style="min-height: 100px;">
    <div id="skillsDisplay" class="skills-list">
      <em style="color:#555">Nenhuma perícia treinada.</em>
    </div>
  </div>

  <div class="row" style="margin-top: 20px;">
    <div class="col">
      <h2>Inventário & Equipamentos</h2>
      <textarea id="itens" style="height: 150px;"></textarea>
    </div>
    <div class="col">
      <h2>Habilidades & Rituais</h2>
      <textarea id="habilidades" style="height: 150px;"></textarea>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn-danger" onclick="App.goBack()">Voltar</button>
    <button onclick="App.exportData()">Exportar .TXT</button>
    <button class="btn-primary" onclick="App.saveData()">Salvar Ficha</button>
  </div>
</div>

<div id="skillModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="App.closeModal()">&times;</span>
    <h2 style="margin-top:0">Gerenciar Perícias</h2>
    <div style="background:#222; padding:10px; margin-bottom:15px; font-size:0.9rem;">
      Pontos Disponíveis: <strong id="modalPoints" style="color:var(--primary)">0</strong>
    </div>
    <div id="modalList">
      </div>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn-primary" onclick="App.closeModal()">Concluir</button>
    </div>
  </div>
</div>

<div id="toast">Dados Salvos!</div>

<script>
const App = {
  // Configurações do Sistema
  config: {
    skills: [
      {id: "atletismo", nome: "Atletismo", attr: "Força", origem: null},
      {id: "luta", nome: "Luta", attr: "Força", origem: "militar"},
      {id: "sobrevivencia", nome: "Sobrevivência", attr: "Resistência", origem: null},
      {id: "vontade", nome: "Vontade", attr: "Resistência", origem: null},
      {id: "diplomacia", nome: "Diplomacia", attr: "Carisma", origem: null},
      {id: "enganacao", nome: "Enganação", attr: "Carisma", origem: "cultista"},
      {id: "intimidacao", nome: "Intimidação", attr: "Carisma", origem: null},
      {id: "persuasao", nome: "Persuasão", attr: "Carisma", origem: "civil"},
      {id: "artes", nome: "Artes", attr: "Carisma", origem: null},
      {id: "furtividade", nome: "Furtividade", attr: "Destreza", origem: null},
      {id: "pontaria", nome: "Pontaria", attr: "Destreza", origem: null},
      {id: "furtar", nome: "Furtar", attr: "Destreza", origem: null},
      {id: "investigacao", nome: "Investigação", attr: "Ideia", origem: "investigador"},
      {id: "percepcao", nome: "Percepção", attr: "Ideia", origem: "investigador"},
      {id: "conhecimento", nome: "Conhecimento", attr: "Ideia", origem: "academico"},
      {id: "pesquisa", nome: "Pesquisa", attr: "Ideia", origem: "academico"},
      {id: "medicina", nome: "Medicina", attr: "Ideia", origem: null},
      {id: "tecnologia", nome: "Tecnologia", attr: "Ideia", origem: null},
      {id: "intuicao", nome: "Intuição", attr: "Ideia", origem: "civil"},
      {id: "ocultismo", nome: "Ocultismo", attr: "Conexão", origem: "cultista"},
      {id: "empatia", nome: "Empatia", attr: "Conexão", origem: null}
    ],
    calcIllumination: (lvl) => Math.max(0, 95 - ((lvl - 1) * 5))
  },

  data: {}, // Dados do personagem
  tempSkills: new Set(), // Set temporário para o modal

  init() {
    this.loadData();
    this.render();
    this.recalc(); // Garante que status derivados estejam corretos
    
    // Auto-save periódico (opcional)
    setInterval(() => {
     // this.saveData(false); // Descomente para autosave silencioso
    }, 30000);
  },

  loadData() {
    // Ordem de prioridade: Ficha Final Salva > Pós-Criação > Criação Base
    const sFicha = JSON.parse(localStorage.getItem("fichaFinal")) || {};
    const sPos = JSON.parse(localStorage.getItem("personagemRPG")) || {}; 
    // Nota: No arquivo anterior, usamos 'personagemRPG' como storage principal

    // Mesclar dados. A ficha salva tem prioridade absoluta.
    this.data = { ...sPos, ...sFicha };

    // Garantir valores padrão se for a primeira vez
    if (this.data.vidaAtual === undefined) this.data.vidaAtual = 0; // Será corrigido no recalc se for 0
    if (this.data.sanidadeAtual === undefined) this.data.sanidadeAtual = 0;
    if (this.data.esforcoAtual === undefined) this.data.esforcoAtual = 0;
    if (!this.data.periciasTodas) this.data.periciasTodas = [];
  },

  render() {
    const d = this.data;

    // Campos de Texto Simples
    ['nome', 'origem', 'classe', 'itens', 'habilidades', 'descricao'].forEach(id => {
      if(document.getElementById(id)) document.getElementById(id).value = d[id] || "";
    });

    // Inputs Numéricos
    ['nivel', 'forca', 'resistencia', 'carisma', 'ideia', 'destreza', 'conexao'].forEach(id => {
      // Tenta pegar o valor Total (do arquivo anterior), senão o base
      const val = d[id] !== undefined ? d[id] : (d[id+'Total'] || 0);
      document.getElementById(id).value = val;
    });

    // Barras Atuais
    document.getElementById('vidaAtual').value = d.vidaAtual;
    document.getElementById('sanidadeAtual').value = d.sanidadeAtual;
    document.getElementById('esforcoAtual').value = d.esforcoAtual;

    this.renderSkillsList();
  },

  recalc() {
    // Pega valores do DOM (porque o usuário pode ter editado manualmente)
    const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
    
    const stats = {
      for: getVal('forca'),
      res: getVal('resistencia'),
      int: getVal('ideia'),
      con: getVal('conexao'),
      lvl: getVal('nivel')
    };

    // Fórmulas
    const maxPV = 10 + (stats.for + (stats.res * 2));
    const maxSAN = 5 + (stats.con + (stats.int * 2));
    const maxPE = 5 + stats.res + stats.con;
    const illum = this.config.calcIllumination(stats.lvl);

    // Atualiza Displays
    document.getElementById('vidaMaxDisplay').textContent = maxPV;
    document.getElementById('sanidadeMaxDisplay').textContent = maxSAN;
    document.getElementById('esforcoMaxDisplay').textContent = maxPE;
    document.getElementById('iluminacao').value = illum;

    // Se a vida atual for 0 (primeiro load), encher tudo
    if (parseInt(document.getElementById('vidaAtual').value) === 0) {
      document.getElementById('vidaAtual').value = maxPV;
      document.getElementById('sanidadeAtual').value = maxSAN;
      document.getElementById('esforcoAtual').value = maxPE;
    }
  },

  adjustStat(id, amount) {
    const el = document.getElementById(id);
    let val = parseInt(el.value) || 0;
    val += amount;
    el.value = val;
  },

  /* --- SISTEMA DE PERÍCIAS --- */

  renderSkillsList() {
    const container = document.getElementById('skillsDisplay');
    const selected = this.data.periciasTodas || [];
    
    if (selected.length === 0) {
      container.innerHTML = '<em style="color:#555">Nenhuma perícia treinada.</em>';
      return;
    }

    // Ordenar alfabeticamente
    selected.sort();

    let html = '';
    selected.forEach(skillName => {
      // Tenta achar metadados da pericia
      const meta = this.config.skills.find(s => s.nome === skillName || s.id === skillName);
      const origemText = (meta && meta.origem) ? `<span class="skill-origin">[${meta.origem.toUpperCase()}]</span>` : '';
      const attrText = meta ? `<small style="color:#666">(${meta.attr.substring(0,3).toUpperCase()})</small>` : '';

      html += `<div class="skill-tag">
        <strong>${skillName}</strong> ${attrText} ${origemText}
      </div>`;
    });
    container.innerHTML = html;
  },

  openModal() {
    this.tempSkills = new Set(this.data.periciasTodas || []);
    const container = document.getElementById('modalList');
    container.innerHTML = '';
    const origemChar = document.getElementById('origem').value.toLowerCase();

    // Cálculo de Pontos (Recalcular dinamicamente)
    const lvl = parseInt(document.getElementById('nivel').value) || 1;
    const pontosTotais = 2 + 2 + Math.floor((lvl - 1) / 5);
    
    // Renderiza Lista
    this.config.skills.forEach(skill => {
      const isAuto = skill.origem === origemChar;
      const isOwned = this.tempSkills.has(skill.nome) || this.tempSkills.has(skill.id);
      
      const div = document.createElement('div');
      div.style.padding = "5px";
      div.style.borderBottom = "1px solid #333";
      
      // Checkbox Logic
      let inputHtml = '';
      if (isAuto) {
        inputHtml = `<input type="checkbox" checked disabled> <span style="color:var(--accent)">Automática</span>`;
        // Garante que está no set
        this.tempSkills.add(skill.nome); 
      } else {
        const checked = isOwned ? 'checked' : '';
        const disabled = (skill.origem && skill.origem !== origemChar) ? 'disabled' : '';
        const labelStyle = disabled ? 'color:#555; text-decoration:line-through' : 'color:var(--text)';
        
        inputHtml = `<input type="checkbox" value="${skill.nome}" ${checked} ${disabled} onchange="App.toggleSkill(this)">`;
      }

      div.innerHTML = `
        <label style="display:flex; justify-content:space-between; align-items:center; cursor:pointer">
          <span>${skill.nome} <small style="color:#666">(${skill.attr})</small></span>
          <div>${inputHtml}</div>
        </label>
      `;
      container.appendChild(div);
    });

    this.updateModalPoints(pontosTotais);
    document.getElementById('skillModal').style.display = 'block';
  },

  toggleSkill(cb) {
    if (cb.checked) this.tempSkills.add(cb.value);
    else this.tempSkills.delete(cb.value);
    
    // Atualiza contador UI
    const lvl = parseInt(document.getElementById('nivel').value) || 1;
    const max = 2 + 2 + Math.floor((lvl - 1) / 5);
    this.updateModalPoints(max);
  },

  updateModalPoints(max) {
    // Conta quantas manuais foram gastas (exclui automáticas da origem)
    const origemChar = document.getElementById('origem').value.toLowerCase();
    let gastas = 0;
    
    this.tempSkills.forEach(sName => {
      const meta = this.config.skills.find(s => s.nome === sName);
      if (meta && meta.origem !== origemChar) gastas++;
    });

    const restante = max - gastas;
    const el = document.getElementById('modalPoints');
    el.textContent = restante;
    el.style.color = restante < 0 ? 'var(--danger)' : 'var(--primary)';
  },

  closeModal() {
    // Salva as alterações temporárias
    this.data.periciasTodas = Array.from(this.tempSkills);
    this.renderSkillsList();
    document.getElementById('skillModal').style.display = 'none';
  },

  /* --- DATA & EXPORT --- */

  saveData(showToast = true) {
    // Coletar dados atuais do DOM
    const d = this.data;
    d.nome = document.getElementById('nome').value;
    d.nivel = document.getElementById('nivel').value;
    d.descricao = document.getElementById('descricao').value;
    d.itens = document.getElementById('itens').value;
    d.habilidades = document.getElementById('habilidades').value;

    d.vidaAtual = document.getElementById('vidaAtual').value;
    d.sanidadeAtual = document.getElementById('sanidadeAtual').value;
    d.esforcoAtual = document.getElementById('esforcoAtual').value;

    d.forca = document.getElementById('forca').value;
    d.resistencia = document.getElementById('resistencia').value;
    d.carisma = document.getElementById('carisma').value;
    d.ideia = document.getElementById('ideia').value;
    d.destreza = document.getElementById('destreza').value;
    d.conexao = document.getElementById('conexao').value;

    localStorage.setItem("fichaFinal", JSON.stringify(d));
    
    if(showToast) {
      const x = document.getElementById("toast");
      x.className = "show";
      setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }
  },

  exportData() {
    this.saveData(false); // Garante que está atualizado
    const d = this.data;
    
    const txt = `
FICHA DE AGENTE: ${d.nome.toUpperCase()}
========================================
Origem: ${d.origem} | Classe: ${d.classe} | Nível: ${d.nivel}

[STATUS]
Vida: ${d.vidaAtual}/${document.getElementById('vidaMaxDisplay').textContent}
Sanidade: ${d.sanidadeAtual}/${document.getElementById('sanidadeMaxDisplay').textContent}
Esforço: ${d.esforcoAtual}/${document.getElementById('esforcoMaxDisplay').textContent}
Iluminação: ${document.getElementById('iluminacao').value}%

[ATRIBUTOS]
FOR: ${d.forca} | RES: ${d.resistencia} | CAR: ${d.carisma}
IDE: ${d.ideia} | DES: ${d.destreza}    | CON: ${d.conexao}

[PERÍCIAS]
${(d.periciasTodas || []).join(', ')}

[EQUIPAMENTO]
${d.itens}

[HABILIDADES & RITUAIS]
${d.habilidades}

[NOTAS]
${d.descricao}
    `.trim();

    const blob = new Blob([txt], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Ficha_${d.nome.replace(/\s+/g, '_')}.txt`;
    link.click();
  },

  goBack() {
    if(confirm("Alterações não salvas serão perdidas. Voltar?")) {
      window.location.href = "pos-criacao.html";
    }
  }
};

// Iniciar
window.addEventListener('DOMContentLoaded', () => App.init());

// Close modal on click outside
window.onclick = function(event) {
  const modal = document.getElementById('skillModal');
  if (event.target == modal) App.closeModal();
}
</script>

</body>
</html>
