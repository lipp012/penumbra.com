<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FICHA FINALIZADA // USO EM JOGO</title>
<style>
  body {
    background:#000;
    color:#00ff66;
    font-family:"Courier New", monospace;
    margin:0;
    padding:0;
  }
  .container {
    width:900px;
    margin:auto;
    border:2px solid #00ff66;
    padding:12px;
    background:#020202;
  }
  h1,h2,h3 { border-bottom:1px solid #00ff66; margin-top:14px; }
  input, textarea { width:100%; background:#000; color:#00ff66; border:1px solid #00ff66; font-family:"Courier New", monospace; margin:4px 0; }
  textarea { resize:vertical; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .box { border:1px solid #00ff66; padding:8px; }
  button { background:#000; color:#00ccff; border:1px solid #00ccff; font-family:"Courier New", monospace; cursor:pointer; margin-top:6px; }
  button:hover { color:#ff0033; border-color:#ff0033; }
  /* POP-UP */
  #modalPericias {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95); color:#00ff66; font-family:'Courier New', monospace; z-index:999; overflow:auto;
  }
  #modalPericias .modal-content {
    width:80%; margin:50px auto; padding:20px; border:2px solid #00ff66; background:#020202;
  }
  .pericia-item { 
    margin:6px 0; 
    padding:8px;
    border-left:2px solid #333;
  }
  .pericia-automatica { 
    border-left:3px solid #ffcc00;
    background:#1a1a00;
    position:relative;
  }
  .pericia-automatica::before {
    content: "✓ AUTOMÁTICA";
    position: absolute;
    top: -8px;
    right: 5px;
    font-size: 9px;
    color: #ffcc00;
    background: #1a1a00;
    padding: 2px 5px;
    border-radius: 3px;
  }
  .pericia-geral { 
    border-left:2px solid #00ccff;
    background:#0a0a0a;
  }
  .pericia-bloqueada { 
    border-left:2px solid #ff3333; 
    background:#330000; 
    opacity: 0.6;
  }
  .origem-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: 8px;
  }
  .origem-academico { background: #002a00; color: #00ff66; }
  .origem-investigador { background: #002a2a; color: #00ccff; }
  .origem-militar { background: #2a0000; color: #ff6666; }
  .origem-civil { background: #2a2a00; color: #ffff66; }
  .origem-cultista { background: #2a002a; color: #ff66ff; }
  .pericia-locked input[type="checkbox"] {
    cursor: not-allowed;
  }
  .info-box {
    background:#111;
    border:1px dashed #00ccff;
    padding:10px;
    margin:10px 0;
    font-size:12px;
  }
  .atributo-input {
    background:#000;
    color:#00ff66;
    border:1px solid #00ff66;
    padding:4px;
    margin:4px 0;
  }
  .status-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
  }
  .status-item {
    background: #111;
    padding: 8px;
    border: 1px solid #333;
  }
  .status-label {
    font-size: 11px;
    color: #aaa;
  }
  .status-value {
    font-size: 14px;
    font-weight: bold;
    color: #00ff66;
  }
</style>
</head>
<body>

<div class="container">

<h1>FICHA FINALIZADA</h1>

<p>Documento operacional para uso em jogo. Alterações são salvas automaticamente.</p>

<div class="info-box" id="debugInfo" style="display:none;">
  <strong>DEBUG:</strong> Carregando dados do personagem...
</div>

<h2>Identidade</h2>
<input id="nome" placeholder="Nome do Personagem">
<textarea id="descricao" placeholder="Descrição física e psicológica"></textarea>

<h2>Raça, Classe, Origem, Nível e Iluminação</h2>
<input id="raca" placeholder="Raça" readonly>
<input id="classe" placeholder="Classe" readonly>
<input id="origem" placeholder="Ocupação/Origem" readonly>
<input id="nivel" placeholder="Nível" type="number" min="1" max="20">
<input id="iluminacao" placeholder="Iluminação" readonly>

<h2>Status</h2>
<div class="grid">
  <div class="box">
    <h3>Status Básicos</h3>
    <label>Vida</label><input id="vida" readonly>
    <label>Sanidade</label><input id="sanidade" readonly>
    <label>Esforço</label><input id="esforco" readonly>
    
    <h3>Status da Aba Anterior</h3>
    <div id="statusAnterior"></div>
  </div>
  <div class="box">
    <h3>Atributos (Editáveis)</h3>
    <div class="status-grid">
      <div class="status-item">
        <div class="status-label">Força</div>
        <div class="status-value"><input id="forca" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('forca')" style="width: 60px;"></div>
      </div>
      <div class="status-item">
        <div class="status-label">Resistência</div>
        <div class="status-value"><input id="resistencia" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('resistencia')" style="width: 60px;"></div>
      </div>
      <div class="status-item">
        <div class="status-label">Carisma</div>
        <div class="status-value"><input id="carisma" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('carisma')" style="width: 60px;"></div>
      </div>
      <div class="status-item">
        <div class="status-label">Ideia</div>
        <div class="status-value"><input id="ideia" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('ideia')" style="width: 60px;"></div>
      </div>
      <div class="status-item">
        <div class="status-label">Destreza</div>
        <div class="status-value"><input id="destreza" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('destreza')" style="width: 60px;"></div>
      </div>
      <div class="status-item">
        <div class="status-label">Conexão</div>
        <div class="status-value"><input id="conexao" type="number" min="0" max="30" class="atributo-input" onchange="atualizarAtributo('conexao')" style="width: 60px;"></div>
      </div>
    </div>
    
    <h3>Detalhes dos Atributos</h3>
    <div id="detalhesAtributos"></div>
  </div>
</div>

<h2>Perícias</h2>
<button onclick="abrirPericias()">Editar Perícias</button>
<div id="periciasResumo"></div>

<!-- POP-UP DAS PERÍCIAS -->
<div id="modalPericias">
  <div class="modal-content">
    <h2>Perícias</h2>
    <div class="info-box">
      <strong>INSTRUÇÕES:</strong> As perícias marcadas com <span style="color:#ffcc00;">✓ AUTOMÁTICA</span> são <strong>obrigatórias da sua origem</strong> e já estão incluídas no personagem. Use seus pontos para selecionar perícias adicionais da lista abaixo.
    </div>
    <div id="periciasContainer"></div>
    <button onclick="fecharPericias()">Fechar e Salvar</button>
  </div>
</div>

<h2>Itens</h2>
<textarea id="itens" placeholder="Equipamentos, armas, objetos paranormais"></textarea>

<h2>Habilidades</h2>
<textarea id="habilidades" placeholder="Habilidades especiais e passivas"></textarea>

<h2>Rituais</h2>
<textarea id="rituais" placeholder="Rituais conhecidos e efeitos"></textarea>

<button onclick="salvarFicha()">SALVAR FICHA</button>
<button onclick="carregarFicha()">CARREGAR FICHA</button>
<button onclick="exportarFicha()">EXPORTAR FICHA (TXT)</button>
<button onclick="voltarParaPosCriacao()">VOLTAR PARA PÓS-CRIAÇÃO</button>

</div>

<script>
// ========== SISTEMA DE CARREGAMENTO DE DADOS ==========

// Mapa de perícias EXATO da aba de pós-criação
const TODAS_PERICIAS_SISTEMA = [
  // Acadêmico
  {nome: "Pesquisa", atributo: "Ideia", descricao: "Encontrar informações em fontes confiáveis", origem: "academico"},
  {nome: "Conhecimento", atributo: "Ideia", descricao: "Saber sobre diversos assuntos acadêmicos", origem: "academico"},
  
  // Investigador
  {nome: "Investigação", atributo: "Ideia", descricao: "Analisar cenas, encontrar pistas", origem: "investigador"},
  {nome: "Percepção", atributo: "Ideia", descricao: "Notar detalhes, perceber perigos", origem: "investigador"},
  
  // Militar
  {nome: "Luta", atributo: "Força", descricao: "Combate corpo-a-corpo", origem: "militar"},
  {nome: "Tática", atributo: "Ideia", descricao: "Planejar estratégias em combate", origem: "militar"},
  
  // Civil
  {nome: "Persuasão", atributo: "Carisma", descricao: "Convencer, negociar no dia a dia", origem: "civil"},
  {nome: "Intuição", atributo: "Ideia", descricao: "Pressentir situações, ler pessoas", origem: "civil"},
  
  // Cultista
  {nome: "Ocultismo", atributo: "Conexao", descricao: "Conhecimento do paranormal e rituais", origem: "cultista"},
  {nome: "Enganação", atributo: "Carisma", descricao: "Mentir, esconder informações", origem: "cultista"},
  
  // Perícias gerais disponíveis para todas as origens
  {nome: "Atletismo", atributo: "Força", descricao: "Correr, saltar, escalar", origem: null},
  {nome: "Sobrevivência", atributo: "Resistência", descricao: "Resistir a elementos, encontrar recursos", origem: null},
  {nome: "Vontade", atributo: "Resistência", descricao: "Resistir a pressão mental, medo", origem: null},
  {nome: "Diplomacia", atributo: "Carisma", descricao: "Lidar com autoridades, negociações formais", origem: null},
  {nome: "Furtividade", atributo: "Destreza", descricao: "Mover-se silenciosamente, esconder-se", origem: null},
  {nome: "Pontaria", atributo: "Destreza", descricao: "Usar armas à distância", origem: null},
  {nome: "Medicina", atributo: "Ideia", descricao: "Primeiros socorros, conhecimento médico", origem: null},
  {nome: "Tecnologia", atributo: "Ideia", descricao: "Usar e consertar equipamentos eletrônicos", origem: null},
  {nome: "Artes", atributo: "Carisma", descricao: "Expressão artística, performance", origem: null},
  {nome: "Empatia", atributo: "Conexao", descricao: "Sentir emoções, conectar-se com outros", origem: null},
  {nome: "Furtar", atributo: "Destreza", descricao: "Pegar objetos sem ser notado", origem: null},
  {nome: "Intimidação", atributo: "Carisma", descricao: "Amassar, coagir pessoas", origem: null},
  {nome: "Navegação", atributo: "Ideia", descricao: "Orientar-se, ler mapas", origem: null},
  {nome: "Animal Handling", atributo: "Conexao", descricao: "Lidar com animais, treiná-los", origem: null},
  {nome: "Memorização", atributo: "Ideia", descricao: "Lembrar de detalhes, informações", origem: null},
  {nome: "Observação", atributo: "Ideia", descricao: "Analisar ambientes, detectar mudanças", origem: null}
];

// Configurações EXATAS da aba de pós-criação
const CONFIG = {
  pontosPericiaBase: 2,
  pontosBonusOrigem: 2,
  bonusPericiaPorNivel: 5,
  
  vidaBase: 10,
  vidaPorForca: 5,
  vidaPorResistencia: 1,
  sanidadeBase: 10,
  sanidadePorIdeia: 3,
  sanidadePorConexao: 1,
  esforcoBase: 5,
  esforcoPorForca: 1,
  bonusVidaPorNivel: 2,
  bonusSanidadePorNivel: 1,
  
  iluminacaoBase: 95, // Alterado para 95
  iluminacaoReducaoPorNivel: 5, // Reduz 5 por nível
  iluminacaoMinima: 0 // Mínimo de iluminação
};

// Variáveis do sistema
let dadosCompletos = {};
let periciasSelecionadas = new Set();
let periciasOrigemAutomaticas = [];
let pontosPericiaDisponiveis = 4;
let dadosStatusAnterior = {};

// ========== FUNÇÕES PRINCIPAIS ==========

function carregarTodosDados() {
  console.log("=== INICIANDO CARREGAMENTO DE DADOS ===");
  
  // 1. Carregar dados da CRIAÇÃO
  let dadosCriacao = JSON.parse(localStorage.getItem("personagemRPG")) || {};
  console.log("Dados da criação:", dadosCriacao);
  
  // 2. Carregar dados da PÓS-CRIAÇÃO
  let dadosPosCriacao = JSON.parse(localStorage.getItem("posCriacaoData")) || {};
  console.log("Dados da pós-criação:", dadosPosCriacao);
  
  // 3. Carregar dados da aba STATUS (pós-criação)
  let dadosStatus = JSON.parse(localStorage.getItem("statusData")) || {};
  console.log("Dados de status da aba anterior:", dadosStatus);
  
  // 4. Carregar dados da FICHA FINAL (se já existir)
  let fichaSalva = JSON.parse(localStorage.getItem("fichaFinal")) || {};
  console.log("Ficha salva anteriormente:", fichaSalva);
  
  // 5. Mesclar dados - PRIORIDADE: Ficha Salva > Status > Pós-Criação > Criação
  dadosCompletos = {};
  
  // Primeiro, dados da criação
  Object.assign(dadosCompletos, dadosCriacao);
  
  // Depois, sobrescreve com dados da pós-criação
  Object.assign(dadosCompletos, dadosPosCriacao);
  
  // Depois, sobrescreve com dados de status
  Object.assign(dadosCompletos, dadosStatus);
  
  // Por último, sobrescreve com dados da ficha final (se existir)
  Object.assign(dadosCompletos, fichaSalva);
  
  // Guardar dados de status separadamente para exibição
  dadosStatusAnterior = dadosStatus;
  
  // Garantir que atributos totais sejam usados e não sejam menores que 0
  if (dadosCriacao.forcaTotal) dadosCompletos.forca = Math.max(0, dadosCriacao.forcaTotal);
  if (dadosCriacao.resistenciaTotal) dadosCompletos.resistencia = Math.max(0, dadosCriacao.resistenciaTotal);
  if (dadosCriacao.carismaTotal) dadosCompletos.carisma = Math.max(0, dadosCriacao.carismaTotal);
  if (dadosCriacao.ideiaTotal) dadosCompletos.ideia = Math.max(0, dadosCriacao.ideiaTotal);
  if (dadosCriacao.destrezaTotal) dadosCompletos.destreza = Math.max(0, dadosCriacao.destrezaTotal);
  if (dadosCriacao.conexaoTotal) dadosCompletos.conexao = Math.max(0, dadosCriacao.conexaoTotal);
  
  console.log("Dados completos mesclados:", dadosCompletos);
  console.log("Dados status anterior:", dadosStatusAnterior);
  
  return dadosCompletos;
}

function preencherCamposComDados(dados) {
  console.log("Preenchendo campos com dados:", dados);
  
  // 1. Identidade
  document.getElementById("nome").value = dados.nome || "";
  document.getElementById("descricao").value = dados.descricao || "";
  
  // 2. Informações básicas
  document.getElementById("raca").value = dados.raca || "";
  document.getElementById("classe").value = dados.classe || "";
  document.getElementById("origem").value = dados.origem || "";
  document.getElementById("nivel").value = dados.nivel || 1;
  
  // 3. Atributos (usar totais se existirem, garantindo mínimo 0)
  const forca = Math.max(0, dados.forcaTotal || dados.forca || 10);
  const resistencia = Math.max(0, dados.resistenciaTotal || dados.resistencia || 10);
  const carisma = Math.max(0, dados.carismaTotal || dados.carisma || 10);
  const ideia = Math.max(0, dados.ideiaTotal || dados.ideia || 10);
  const destreza = Math.max(0, dados.destrezaTotal || dados.destreza || 10);
  const conexao = Math.max(0, dados.conexaoTotal || dados.conexao || 10);
  
  document.getElementById("forca").value = forca;
  document.getElementById("resistencia").value = resistencia;
  document.getElementById("carisma").value = carisma;
  document.getElementById("ideia").value = ideia;
  document.getElementById("destreza").value = destreza;
  document.getElementById("conexao").value = conexao;
  
  // Atualizar dados completos
  dadosCompletos.forca = forca;
  dadosCompletos.resistencia = resistencia;
  dadosCompletos.carisma = carisma;
  dadosCompletos.ideia = ideia;
  dadosCompletos.destreza = destreza;
  dadosCompletos.conexao = conexao;
  
  // 4. Status calculados
  calcularStatusAutomatico(dados);
  
  // 5. Exibir status da aba anterior
  exibirStatusAnterior(dadosStatusAnterior);
  
  // 6. Exibir detalhes dos atributos
  exibirDetalhesAtributos(dados);
  
  // 7. Conteúdo
  document.getElementById("itens").value = dados.itens || "";
  document.getElementById("habilidades").value = dados.habilidades || "";
  document.getElementById("rituais").value = dados.rituais || "";
  
  // 8. Perícias
  carregarPericiasDoPersonagem(dados);
}

function exibirStatusAnterior(dadosStatus) {
  const container = document.getElementById("statusAnterior");
  
  if (!dadosStatus || Object.keys(dadosStatus).length === 0) {
    container.innerHTML = "<em style='color:#666;'>Nenhum dado de status da aba anterior encontrado.</em>";
    return;
  }
  
  let html = '<div class="status-grid">';
  
  // Mapear os campos de status que podem vir da aba anterior
  const camposStatus = [
    { key: 'vidaAtual', label: 'Vida Atual', color: '#ff3333' },
    { key: 'vidaMaxima', label: 'Vida Máxima', color: '#ff6666' },
    { key: 'sanidadeAtual', label: 'Sanidade Atual', color: '#3366ff' },
    { key: 'sanidadeMaxima', label: 'Sanidade Máxima', color: '#6699ff' },
    { key: 'esforcoAtual', label: 'Esforço Atual', color: '#33cc33' },
    { key: 'esforcoMaximo', label: 'Esforço Máximo', color: '#66ff66' },
    { key: 'defesa', label: 'Defesa', color: '#ffcc00' },
    { key: 'iniciativa', label: 'Iniciativa', color: '#ff9900' },
    { key: 'movimento', label: 'Movimento', color: '#cc66ff' }
  ];
  
  camposStatus.forEach(campo => {
    if (dadosStatus[campo.key] !== undefined) {
      html += `
        <div class="status-item">
          <div class="status-label">${campo.label}</div>
          <div class="status-value" style="color:${campo.color}">${dadosStatus[campo.key]}</div>
        </div>
      `;
    }
  });
  
  html += '</div>';
  
  // Adicionar notas se existirem
  if (dadosStatus.notas) {
    html += `<div style="margin-top:10px; font-size:11px; color:#aaa;">
      <strong>Notas:</strong> ${dadosStatus.notas}
    </div>`;
  }
  
  container.innerHTML = html;
}

function exibirDetalhesAtributos(dados) {
  const container = document.getElementById("detalhesAtributos");
  let html = '<div style="font-size:11px; color:#aaa;">';
  
  // Verificar se há dados de atributos da aba anterior
  if (dadosStatusAnterior) {
    html += '<strong>Dados da Aba Anterior:</strong><br>';
    
    // Exibir base e bônus se existirem
    const atributos = ['forca', 'resistencia', 'carisma', 'ideia', 'destreza', 'conexao'];
    
    atributos.forEach(atributo => {
      const base = dadosStatusAnterior[`${atributo}Base`];
      const bonus = dadosStatusAnterior[`${atributo}Bonus`];
      
      if (base !== undefined || bonus !== undefined) {
        html += `${formatarTexto(atributo)}: Base ${base || 0}`;
        if (bonus) html += ` + Bônus ${bonus}`;
        html += `<br>`;
      }
    });
    
    html += '<br>';
  }
  
  // Exibir cálculo da vida, sanidade e esforço
  html += '<strong>Cálculos Atuais:</strong><br>';
  
  const forca = Math.max(0, parseInt(dados.forca || 10));
  const resistencia = Math.max(0, parseInt(dados.resistencia || 10));
  const ideia = Math.max(0, parseInt(dados.ideia || 10));
  const conexao = Math.max(0, parseInt(dados.conexao || 10));
  const nivel = Math.max(1, parseInt(dados.nivel || 1));
  
  html += `Vida: ${CONFIG.vidaBase} + (Força ${forca} × ${CONFIG.vidaPorForca}) + (Resistência ${resistencia} × ${CONFIG.vidaPorResistencia}) + (Nível ${nivel} × ${CONFIG.bonusVidaPorNivel})<br>`;
  html += `Sanidade: ${CONFIG.sanidadeBase} + (Ideia ${ideia} × ${CONFIG.sanidadePorIdeia}) + (Conexão ${conexao} × ${CONFIG.sanidadePorConexao}) + (Nível ${nivel} × ${CONFIG.bonusSanidadePorNivel})<br>`;
  html += `Esforço: ${CONFIG.esforcoBase} + (Força ${forca} × ${CONFIG.esforcoPorForca}) + (Nível ${nivel} ÷ 2)<br>`;
  html += `Iluminação: ${CONFIG.iluminacaoBase} - ((Nível ${nivel} - 1) × ${CONFIG.iluminacaoReducaoPorNivel})`;
  
  html += '</div>';
  container.innerHTML = html;
}

function atualizarAtributo(atributo) {
  const input = document.getElementById(atributo);
  let valor = parseInt(input.value) || 0;
  
  // Garantir que o valor não seja menor que 0
  if (valor < 0) {
    valor = 0;
    input.value = 0;
  }
  
  // Atualizar dados completos
  dadosCompletos[atributo] = valor;
  
  // Recalcular status
  calcularStatusAutomatico(dadosCompletos);
  exibirDetalhesAtributos(dadosCompletos);
}

function carregarPericiasDoPersonagem(dados) {
  // Limpar seleções anteriores
  periciasSelecionadas.clear();
  periciasOrigemAutomaticas = [];
  
  // Determinar origem do personagem
  const origemPersonagem = dados.origem;
  
  // Carregar perícias da origem (automáticas)
  if (origemPersonagem) {
    periciasOrigemAutomaticas = TODAS_PERICIAS_SISTEMA.filter(p => p.origem === origemPersonagem);
    
    // Adicionar automaticamente as perícias da origem
    periciasOrigemAutomaticas.forEach(p => {
      periciasSelecionadas.add(p.nome);
    });
  }
  
  // Adicionar perícias extras escolhidas
  if (dados.periciasExtras) {
    dados.periciasExtras.forEach(p => {
      // VERIFICAR SE A PERÍCIA É PERMITIDA PARA ESTA ORIGEM
      const periciaInfo = TODAS_PERICIAS_SISTEMA.find(per => per.nome === p);
      if (periciaInfo) {
        // Permitir apenas se for geral (origem: null) ou da própria origem
        if (periciaInfo.origem === null || periciaInfo.origem === origemPersonagem) {
          periciasSelecionadas.add(p);
        }
      }
    });
  }
  
  // Adicionar todas as perícias se existir (com verificação)
  if (dados.periciasTodas) {
    dados.periciasTodas.forEach(p => {
      const periciaInfo = TODAS_PERICIAS_SISTEMA.find(per => per.nome === p);
      if (periciaInfo) {
        if (periciaInfo.origem === null || periciaInfo.origem === origemPersonagem) {
          periciasSelecionadas.add(p);
        }
      }
    });
  }
  
  // Calcular pontos de perícia
  calcularPontosPericia();
  
  // Atualizar resumo
  atualizarResumoPericias();
}

function calcularPontosPericia() {
  const nivel = parseInt(dadosCompletos.nivel) || 1;
  
  // Calcular pontos totais disponíveis (EXATO da aba pós-criação)
  const pontosBase = CONFIG.pontosPericiaBase; // 2
  const pontosOrigem = CONFIG.pontosBonusOrigem; // 2
  const bonusNivel = Math.floor((nivel - 1) / CONFIG.bonusPericiaPorNivel); // 5 níveis por ponto extra
  const pontosTotais = pontosBase + pontosOrigem + bonusNivel;
  
  // Calcular pontos já gastos (EXCLUINDO as automáticas da origem)
  const periciasExtras = Array.from(periciasSelecionadas).filter(p => 
    !periciasOrigemAutomaticas.some(auto => auto.nome === p)
  );
  const pontosGastos = periciasExtras.length;
  
  // Calcular pontos restantes
  pontosPericiaDisponiveis = pontosTotais - pontosGastos;
  if (pontosPericiaDisponiveis < 0) pontosPericiaDisponiveis = 0;
  
  return pontosPericiaDisponiveis;
}

// ========== SISTEMA DE PERÍCIAS (COM BLOQUEIO) ==========

function abrirPericias() {
  const container = document.getElementById("periciasContainer");
  container.innerHTML = "";
  
  const origemPersonagem = dadosCompletos.origem;
  
  // Separar perícias conforme a origem do personagem (EXATO como na aba pós-criação)
  const periciasDaOrigem = TODAS_PERICIAS_SISTEMA.filter(p => p.origem === origemPersonagem);
  const periciasGerais = TODAS_PERICIAS_SISTEMA.filter(p => p.origem === null);
  const periciasOutrasOrigens = TODAS_PERICIAS_SISTEMA.filter(p => 
    p.origem !== null && p.origem !== origemPersonagem
  );
  
  // 1. PERÍCIAS DA ORIGEM ATUAL (AUTOMÁTICAS)
  if (periciasDaOrigem.length > 0) {
    const titulo = document.createElement('h3');
    titulo.style.color = '#ffcc00';
    titulo.style.marginTop = '15px';
    titulo.style.borderBottom = '1px solid #ffcc00';
    titulo.textContent = `Perícias da Origem: ${formatarTexto(origemPersonagem)}`;
    container.appendChild(titulo);
    
    periciasDaOrigem.forEach(p => {
      const div = criarElementoPericia(p, true);
      container.appendChild(div);
    });
  }
  
  // 2. PERÍCIAS GERAIS (DISPONÍVEIS PARA TODOS)
  if (periciasGerais.length > 0) {
    const titulo = document.createElement('h3');
    titulo.style.color = '#00ccff';
    titulo.style.marginTop = '20px';
    titulo.style.borderBottom = '1px solid #00ccff';
    titulo.textContent = 'Perícias Gerais Disponíveis';
    container.appendChild(titulo);
    
    periciasGerais.forEach(p => {
      const div = criarElementoPericia(p, false);
      container.appendChild(div);
    });
  }
  
  // 3. PERÍCIAS DE OUTRAS ORIGENS (BLOQUEADAS)
  if (periciasOutrasOrigens.length > 0) {
    const titulo = document.createElement('h3');
    titulo.style.color = '#666';
    titulo.style.marginTop = '20px';
    titulo.style.borderBottom = '1px solid #666';
    titulo.textContent = 'Perícias de Outras Origens (Não Disponíveis)';
    container.appendChild(titulo);
    
    periciasOutrasOrigens.forEach(p => {
      const div = criarElementoPericia(p, false, true);
      container.appendChild(div);
    });
  }
  
  document.getElementById("modalPericias").style.display = "block";
}

function criarElementoPericia(pericia, isAutomatica = false, isBloqueada = false) {
  const div = document.createElement("div");
  
  if (isAutomatica) {
    div.className = "pericia-item pericia-automatica";
  } else if (isBloqueada) {
    div.className = "pericia-item pericia-bloqueada";
  } else {
    div.className = "pericia-item pericia-geral";
  }
  
  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "5px";
  
  const nomeSpan = document.createElement("span");
  nomeSpan.style.fontWeight = "bold";
  nomeSpan.style.color = isAutomatica ? "#ffcc00" : (isBloqueada ? "#666" : "#00ccff");
  nomeSpan.textContent = pericia.nome;
  
  const atributoSpan = document.createElement("span");
  atributoSpan.style.fontSize = "11px";
  atributoSpan.style.color = "#ff9900";
  atributoSpan.style.background = "#1a1a00";
  atributoSpan.style.padding = "2px 6px";
  atributoSpan.style.borderRadius = "3px";
  atributoSpan.textContent = pericia.atributo;
  
  header.appendChild(nomeSpan);
  header.appendChild(atributoSpan);
  
  const desc = document.createElement("div");
  desc.style.fontSize = "11px";
  desc.style.color = "#aaa";
  desc.style.marginTop = "3px";
  desc.textContent = pericia.descricao;
  
  // Checkbox
  const checkboxContainer = document.createElement("div");
  checkboxContainer.style.marginTop = "5px";
  
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.value = pericia.nome;
  cb.checked = periciasSelecionadas.has(pericia.nome);
  
  // Aplicar regras de bloqueio (EXATAS da aba pós-criação)
  if (isAutomatica) {
    cb.disabled = true;
    cb.checked = true;
  } else if (isBloqueada) {
    cb.disabled = true;
    cb.checked = false;
    cb.className = "pericia-locked";
  } else {
    // Para perícias gerais: verificar pontos disponíveis
    cb.disabled = (pontosPericiaDisponiveis <= 0 && !cb.checked);
  }
  
  cb.onclick = () => selecionarPericia(cb, pericia.nome, isAutomatica);
  
  const label = document.createElement("span");
  label.style.marginLeft = "5px";
  label.style.fontSize = "11px";
  label.style.color = isAutomatica ? "#ffcc00" : (isBloqueada ? "#666" : "#aaa");
  
  if (isAutomatica) {
    label.textContent = " (Obrigatória da origem)";
  } else if (isBloqueada) {
    label.textContent = " (Exclusiva de outra origem)";
  } else {
    label.textContent = " Selecionar";
  }
  
  // Badge de origem se aplicável
  if (pericia.origem && !isAutomatica) {
    const origemBadge = document.createElement("span");
    origemBadge.className = `origem-badge origem-${pericia.origem}`;
    origemBadge.textContent = formatarTexto(pericia.origem);
    origemBadge.style.marginLeft = "10px";
    label.appendChild(origemBadge);
  }
  
  checkboxContainer.appendChild(cb);
  checkboxContainer.appendChild(label);
  
  div.appendChild(header);
  div.appendChild(desc);
  div.appendChild(checkboxContainer);
  
  return div;
}

function selecionarPericia(checkbox, nomePericia, isAutomatica = false) {
  // Verificar se é automática (não pode desselecionar)
  if (isAutomatica) {
    checkbox.checked = true;
    alert("Esta perícia é obrigatória da sua origem e não pode ser removida!");
    return;
  }
  
  if (checkbox.checked) {
    // Verificar pontos disponíveis
    if (pontosPericiaDisponiveis <= 0) {
      checkbox.checked = false;
      alert("Não há mais pontos de perícia disponíveis!");
      return;
    }
    
    periciasSelecionadas.add(nomePericia);
  } else {
    periciasSelecionadas.delete(nomePericia);
  }
  
  // Recalcular pontos
  calcularPontosPericia();
  
  // Atualizar resumo
  atualizarResumoPericias();
  
  // Reabrir o pop-up para atualizar estados dos checkboxes
  abrirPericias();
}

function fecharPericias() {
  document.getElementById("modalPericias").style.display = "none";
  calcularPontosPericia();
  atualizarResumoPericias();
  salvarFicha(false);
}

function atualizarResumoPericias() {
  const resumo = document.getElementById("periciasResumo");
  const lista = Array.from(periciasSelecionadas);
  
  if (lista.length === 0) {
    resumo.innerHTML = "<em>Nenhuma perícia selecionada</em>";
    return;
  }
  
  // Separar por tipo
  const periciasDaOrigemLista = lista.filter(p => 
    periciasOrigemAutomaticas.some(auto => auto.nome === p)
  );
  
  const periciasExtrasLista = lista.filter(p => 
    !periciasOrigemAutomaticas.some(auto => auto.nome === p)
  );
  
  let html = `<strong>Perícias selecionadas (${lista.length}):</strong><br>`;
  
  if (periciasDaOrigemLista.length > 0) {
    html += `<div style="margin-left:10px; color:#ffcc00;">
      <small>Origem (automáticas):</small> ${periciasDaOrigemLista.join(", ")}
    </div>`;
  }
  
  if (periciasExtrasLista.length > 0) {
    html += `<div style="margin-left:10px; color:#00ccff;">
      <small>Extras (${periciasExtrasLista.length}):</small> ${periciasExtrasLista.join(", ")}
    </div>`;
  }
  
  html += `<div style="margin-top:5px; font-size:11px; color:#aaa;">
    Pontos disponíveis: ${pontosPericiaDisponiveis}
  </div>`;
  
  resumo.innerHTML = html;
}

// ========== CÁLCULOS AUTOMÁTICOS ==========

function calcularStatusAutomatico(dados) {
  const forca = Math.max(0, parseInt(dados.forcaTotal || dados.forca || 10));
  const resistencia = Math.max(0, parseInt(dados.resistenciaTotal || dados.resistencia || 10));
  const ideia = Math.max(0, parseInt(dados.ideiaTotal || dados.ideia || 10));
  const conexao = Math.max(0, parseInt(dados.conexaoTotal || dados.conexao || 10));
  const nivel = Math.max(1, parseInt(dados.nivel || 1));
  
  // FÓRMULAS EXATAS da aba pós-criação
  const vida = CONFIG.vidaBase + 
               (forca * CONFIG.vidaPorForca) + 
               (resistencia * CONFIG.vidaPorResistencia) +
               (nivel * CONFIG.bonusVidaPorNivel);
  
  const sanidade = CONFIG.sanidadeBase + 
                   (ideia * CONFIG.sanidadePorIdeia) + 
                   (conexao * CONFIG.sanidadePorConexao) +
                   (nivel * CONFIG.bonusSanidadePorNivel);
  
  const esforco = CONFIG.esforcoBase + 
                  (forca * CONFIG.esforcoPorForca) +
                  Math.floor(nivel / 2);
  
  // Iluminação: base 95, reduz 5 por nível (nível 1 = 95, nível 2 = 90, etc.)
  const iluminacao = Math.max(
    CONFIG.iluminacaoMinima, 
    CONFIG.iluminacaoBase - ((nivel - 1) * CONFIG.iluminacaoReducaoPorNivel)
  );
  
  document.getElementById("vida").value = vida;
  document.getElementById("sanidade").value = sanidade;
  document.getElementById("esforco").value = esforco;
  document.getElementById("iluminacao").value = iluminacao;
}

// ========== FUNÇÕES DE SALVAMENTO ==========

function salvarFicha(mostrarAlerta = true) {
  const ficha = {
    nome: document.getElementById("nome").value,
    descricao: document.getElementById("descricao").value,
    vida: document.getElementById("vida").value,
    sanidade: document.getElementById("sanidade").value,
    esforco: document.getElementById("esforco").value,
    raca: document.getElementById("raca").value,
    classe: document.getElementById("classe").value,
    origem: document.getElementById("origem").value,
    nivel: document.getElementById("nivel").value,
    iluminacao: document.getElementById("iluminacao").value,
    itens: document.getElementById("itens").value,
    habilidades: document.getElementById("habilidades").value,
    rituais: document.getElementById("rituais").value,
    
    // Atributos atuais
    forca: document.getElementById("forca").value,
    resistencia: document.getElementById("resistencia").value,
    carisma: document.getElementById("carisma").value,
    ideia: document.getElementById("ideia").value,
    destreza: document.getElementById("destreza").value,
    conexao: document.getElementById("conexao").value,
    
    // Dados de status da aba anterior
    statusAnterior: dadosStatusAnterior,
    
    // Perícias
    periciasAutomaticas: periciasOrigemAutomaticas.map(p => p.nome),
    periciasExtras: Array.from(periciasSelecionadas).filter(p => 
      !periciasOrigemAutomaticas.some(auto => auto.nome === p)
    ),
    periciasTodas: Array.from(periciasSelecionadas),
    
    // Atributos como objeto também
    atributos: {
      forca: document.getElementById("forca").value,
      resistencia: document.getElementById("resistencia").value,
      carisma: document.getElementById("carisma").value,
      ideia: document.getElementById("ideia").value,
      destreza: document.getElementById("destreza").value,
      conexao: document.getElementById("conexao").value
    },
    
    // Metadados
    dataSalvamento: new Date().toISOString()
  };
  
  localStorage.setItem("fichaFinal", JSON.stringify(ficha, null, 2));
  
  if (mostrarAlerta) {
    alert("Ficha salva com sucesso!");
  }
}

function carregarFicha() {
  const ficha = JSON.parse(localStorage.getItem("fichaFinal"));
  if (!ficha) {
    alert("Nenhuma ficha salva encontrada. Carregando dados do personagem...");
    const dados = carregarTodosDados();
    preencherCamposComDados(dados);
    return;
  }
  
  // Preencher campos com dados da ficha salva
  Object.keys(ficha).forEach(key => {
    if (key === "atributos" || key === "periciasTodas" || key === "periciasAutomaticas" || key === "periciasExtras" || key === "statusAnterior") {
      return; // Tratados separadamente
    }
    
    const elemento = document.getElementById(key);
    if (elemento && ficha[key] !== undefined) {
      elemento.value = ficha[key];
    }
  });
  
  // Atributos individuais (diretos)
  if (ficha.forca) document.getElementById("forca").value = Math.max(0, ficha.forca);
  if (ficha.resistencia) document.getElementById("resistencia").value = Math.max(0, ficha.resistencia);
  if (ficha.carisma) document.getElementById("carisma").value = Math.max(0, ficha.carisma);
  if (ficha.ideia) document.getElementById("ideia").value = Math.max(0, ficha.ideia);
  if (ficha.destreza) document.getElementById("destreza").value = Math.max(0, ficha.destreza);
  if (ficha.conexao) document.getElementById("conexao").value = Math.max(0, ficha.conexao);
  
  // Atributos do objeto
  if (ficha.atributos) {
    Object.keys(ficha.atributos).forEach(attr => {
      const elemento = document.getElementById(attr);
      if (elemento) elemento.value = Math.max(0, ficha.atributos[attr]);
    });
  }
  
  // Status anterior
  if (ficha.statusAnterior) {
    dadosStatusAnterior = ficha.statusAnterior;
    exibirStatusAnterior(dadosStatusAnterior);
  }
  
  // Perícias
  if (ficha.periciasTodas) {
    periciasSelecionadas = new Set(ficha.periciasTodas);
    
    // Carregar perícias da origem automaticamente
    const origem = document.getElementById("origem").value;
    if (origem) {
      periciasOrigemAutomaticas = TODAS_PERICIAS_SISTEMA.filter(p => p.origem === origem);
      
      // Garantir que as perícias da origem estejam selecionadas
      periciasOrigemAutomaticas.forEach(p => {
        periciasSelecionadas.add(p.nome);
      });
    }
    
    calcularPontosPericia();
    atualizarResumoPericias();
  }
  
  // Recalcular status
  calcularStatusAutomatico({
    forca: document.getElementById("forca").value,
    resistencia: document.getElementById("resistencia").value,
    ideia: document.getElementById("ideia").value,
    conexao: document.getElementById("conexao").value,
    nivel: document.getElementById("nivel").value
  });
  
  // Atualizar detalhes
  exibirDetalhesAtributos({
    forca: document.getElementById("forca").value,
    resistencia: document.getElementById("resistencia").value,
    ideia: document.getElementById("ideia").value,
    conexao: document.getElementById("conexao").value,
    nivel: document.getElementById("nivel").value
  });
  
  alert("Ficha carregada com sucesso!");
}

function exportarFicha() {
  const todasPericias = Array.from(periciasSelecionadas);
  
  const texto = `FICHA DE PERSONAGEM

Nome: ${document.getElementById("nome").value}
Descrição: ${document.getElementById("descricao").value}

INFORMAÇÕES
-----------
Raça: ${document.getElementById("raca").value}
Classe: ${document.getElementById("classe").value}
Origem: ${document.getElementById("origem").value}
Nível: ${document.getElementById("nivel").value}
Iluminação: ${document.getElementById("iluminacao").value}

STATUS
------
Vida: ${document.getElementById("vida").value}
Sanidade: ${document.getElementById("sanidade").value}
Esforço: ${document.getElementById("esforco").value}

ATRIBUTOS
---------
Força: ${document.getElementById("forca").value}
Resistência: ${document.getElementById("resistencia").value}
Carisma: ${document.getElementById("carisma").value}
Ideia: ${document.getElementById("ideia").value}
Destreza: ${document.getElementById("destreza").value}
Conexão: ${document.getElementById("conexao").value}

PERÍCIAS (${todasPericias.length})
---------
${todasPericias.map(p => `• ${p}`).join('\n')}

ITENS
-----
${document.getElementById("itens").value}

HABILIDADES
-----------
${document.getElementById("habilidades").value}

RITUAIS
-------
${document.getElementById("rituais").value}

-----------------------------------
Exportado em: ${new Date().toLocaleString()}`;

  const blob = new Blob([texto], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `ficha_${document.getElementById("nome").value || 'personagem'}.txt`;
  link.click();
}

function voltarParaPosCriacao() {
  salvarFicha(false);
  window.location.href = "pos-criacao.html";
}

// ========== FUNÇÕES AUXILIARES ==========

function formatarTexto(texto) {
  if (!texto) return "";
  return texto.charAt(0).toUpperCase() + texto.slice(1);
}

// ========== INICIALIZAÇÃO ==========

document.addEventListener('DOMContentLoaded', function() {
  console.log("Página carregada, buscando dados...");
  
  // 1. Carregar todos os dados disponíveis
  const dados = carregarTodosDados();
  
  // 2. Preencher os campos com esses dados
  preencherCamposComDados(dados);
  
  // 3. Atualizar status quando nível mudar
  document.getElementById("nivel").addEventListener("change", function() {
    dadosCompletos.nivel = this.value;
    calcularStatusAutomatico(dadosCompletos);
    calcularPontosPericia();
    atualizarResumoPericias();
    exibirDetalhesAtributos(dadosCompletos);
  });
  
  // 4. Atualizar status quando atributos mudarem
  document.querySelectorAll('.atributo-input').forEach(input => {
    input.addEventListener('change', function() {
      atualizarAtributo(this.id);
    });
  });
});
</script>

</body>
</html>