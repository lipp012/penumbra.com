<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PÓS-CRIAÇÃO // STATUS DO AGENTE</title>
  
  <style>
    /* --- VARIÁVEIS DE TEMA (Fácil de mudar cores aqui) --- */
    :root {
      --bg-color: #050505;
      --panel-bg: #0a0a0a;
      --primary-color: #00ff66;       /* Verde Matrix */
      --secondary-color: #00ccff;     /* Azul Neon */
      --accent-color: #ffcc00;        /* Amarelo */
      --danger-color: #ff0033;        /* Vermelho Erro */
      --text-color: #e0e0e0;
      --border-radius: 4px;
      --font-mono: "Courier New", monospace;
    }

    /* --- RESET E BASE --- */
    * { box-sizing: border-box; }
    
    body {
      background-color: #000;
      color: var(--primary-color);
      font-family: var(--font-mono);
      margin: 0;
      padding: 20px;
      font-size: 14px;
      line-height: 1.4;
    }

    /* --- LAYOUT --- */
    .container {
      max-width: 900px;
      margin: 0 auto;
      border: 1px solid var(--primary-color);
      padding: 20px;
      background-color: var(--bg-color);
      box-shadow: 0 0 15px rgba(0, 255, 102, 0.1);
    }

    /* --- TIPOGRAFIA --- */
    h1, h2, h3 {
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 0;
    }

    h1 {
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    h2 {
      border-left: 4px solid var(--secondary-color);
      padding-left: 10px;
      font-size: 1.1rem;
      margin-top: 30px;
      color: var(--text-color);
    }

    /* --- PAINÉIS E CAIXAS --- */
    .info-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: var(--panel-bg);
      border: 1px solid #333;
      padding: 10px;
      margin-bottom: 20px;
      color: var(--text-color);
    }

    .info-item strong { color: var(--secondary-color); }

    .warning-box {
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
      background: rgba(255, 0, 51, 0.1);
      padding: 10px;
      text-align: center;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    /* --- GRID DE ATRIBUTOS --- */
    .grid-atributos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #111;
      padding: 10px;
      border: 1px solid #333;
      text-align: center;
    }

    .stat-label { color: var(--secondary-color); font-weight: bold; display: block; }
    .stat-detail { font-size: 0.75rem; color: #666; display: block; margin: 5px 0; }
    
    input[type="number"], input[type="text"] {
      width: 100%;
      background: #000;
      border: 1px solid #444;
      color: var(--primary-color);
      font-family: var(--font-mono);
      font-size: 1.2rem;
      text-align: center;
      padding: 5px;
    }
    
    input[readonly] { cursor: default; }
    input:focus { outline: none; border-color: var(--primary-color); }

    /* STATUS DERIVADOS (PV, SAN, PE) */
    .derived-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed var(--primary-color);
    }

    .derived-input {
      color: var(--accent-color) !important;
      font-weight: bold;
      border-color: var(--accent-color) !important;
    }

    /* --- SISTEMA DE PERÍCIAS --- */
    .points-panel {
      background: var(--panel-bg);
      border: 1px dashed var(--secondary-color);
      padding: 15px;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 10; /* Fica no topo ao rolar */
      box-shadow: 0 4px 10px rgba(0,0,0,0.8);
    }

    .progress-wrapper {
      margin-top: 10px;
      background: #222;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: var(--secondary-color);
      width: 0%;
      transition: width 0.3s ease, background-color 0.3s;
    }

    .progress-bar.full { background: var(--danger-color); }
    
    .status-text {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .msg-feedback {
      color: var(--danger-color);
      font-size: 0.85rem;
      height: 1.2rem; 
      margin-top: 5px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .msg-feedback.visible { opacity: 1; }

    /* LISTA DE PERÍCIAS */
    .pericia-list-container {
      max-height: 450px;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 5px;
      background: #080808;
    }

    .pericia-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 4px;
      background: #121212;
      border-left: 3px solid transparent;
      transition: background 0.2s;
    }

    .pericia-item:hover { background: #1a1a1a; }
    
    /* Estados das Perícias */
    .pericia-item.selected {
      border-left-color: var(--secondary-color);
      background: rgba(0, 204, 255, 0.05);
    }
    .pericia-item.automatic {
      border-left-color: var(--accent-color);
      background: rgba(255, 204, 0, 0.05);
    }
    .pericia-item.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

    .pericia-content { flex: 1; }
    .p-name { font-weight: bold; color: var(--text-color); font-size: 1rem; }
    .p-attr { font-size: 0.7rem; background: #333; padding: 2px 4px; border-radius: 3px; margin-left: 8px; color: #aaa; text-transform: uppercase;}
    .p-desc { font-size: 0.8rem; color: #777; margin-top: 4px; display: block; }

    /* Checkbox Customizado */
    .checkbox-wrapper { display: flex; align-items: center; gap: 10px; }
    .custom-cb {
      width: 20px; height: 20px;
      border: 1px solid #555;
      background: #000;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .custom-cb.checked { background: var(--secondary-color); border-color: var(--secondary-color); color: #000; }
    .custom-cb.auto { background: var(--accent-color); border-color: var(--accent-color); color: #000; cursor: default; }

    /* --- BOTÕES --- */
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #333;
    }

    button {
      background: transparent;
      color: var(--secondary-color);
      border: 1px solid var(--secondary-color);
      padding: 12px 24px;
      font-family: var(--font-mono);
      font-size: 1rem;
      cursor: pointer;
      text-transform: uppercase;
      font-weight: bold;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--secondary-color);
      color: #000;
      box-shadow: 0 0 10px var(--secondary-color);
    }

    button.btn-back { color: var(--danger-color); border-color: var(--danger-color); }
    button.btn-back:hover { background: var(--danger-color); color: #fff; box-shadow: 0 0 10px var(--danger-color); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Mobile */
    @media (max-width: 600px) {
      .derived-stats { grid-template-columns: 1fr; }
      .actions { flex-direction: column-reverse; }
      button { width: 100%; }
      .status-text { flex-direction: column; align-items: flex-start; gap: 5px; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Status do Personagem</h1>
  <div class="warning-box">⚠ DADOS CALCULADOS AUTOMATICAMENTE. EVITE EDIÇÃO MANUAL.</div>

  <div class="info-bar">
    <span class="info-item"><strong>Agente:</strong> <span id="viewNome">...</span></span>
    <span class="info-item"><strong>Origem:</strong> <span id="viewOrigem">...</span></span>
    <span class="info-item"><strong>Classe:</strong> <span id="viewClasse">...</span></span>
    <span class="info-item"><strong>Nível:</strong> <span id="viewNivel">...</span></span>
  </div>

  <h2>1. Atributos & Derivados</h2>
  <div class="grid-atributos" id="gridAtributos">
    </div>

  <div class="derived-stats">
    <div class="stat-card">
      <label class="stat-label">PV (Vida)</label>
      <input type="text" id="pv" class="derived-input" readonly>
      <span class="stat-detail">10 + (Força + Res*2)</span>
    </div>
    <div class="stat-card">
      <label class="stat-label">SAN (Sanidade)</label>
      <input type="text" id="san" class="derived-input" readonly>
      <span class="stat-detail">5 + (Conexão + Ideia*2)</span>
    </div>
    <div class="stat-card">
      <label class="stat-label">PE (Esforço)</label>
      <input type="text" id="pe" class="derived-input" readonly>
      <span class="stat-detail">5 + Res + Conexão</span>
    </div>
  </div>

  <h2>2. Treinamento de Perícias</h2>
  
  <div class="points-panel">
    <div class="status-text">
      <div>
        <strong>PONTOS DISPONÍVEIS:</strong> 
        <span id="displayPontos" style="font-size: 1.4rem; color: var(--primary-color);">0</span>
      </div>
      <div style="font-size: 0.8rem; color: #888;">
        Base (<span id="txtBase">0</span>) + Origem (<span id="txtOrigem">0</span>) + Nível (<span id="txtNivel">0</span>)
      </div>
    </div>
    
    <div class="progress-wrapper">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="feedbackMsg" class="msg-feedback"></div>
  </div>

  <div class="pericia-list-container" id="listaPericias">
    </div>

  <div class="actions">
    <button class="btn-back" id="btnVoltar">Voltar</button>
    <button id="btnSalvar">Salvar & Finalizar</button>
  </div>
</div>

<script>
/**
 * LÓGICA DO SISTEMA (MODULAR)
 */
const App = {
  // Configurações do RPG
  config: {
    pontosBase: 2,
    pontosOrigem: 2,
    divisorNivel: 5,
    atributos: ['forca', 'resistencia', 'carisma', 'ideia', 'destreza', 'conexao'],
    // Lista completa de perícias
    pericias: [
      { id: "pesquisa", nome: "Pesquisa", atributo: "Ideia", desc: "Buscar dados e pistas.", origem: "academico" },
      { id: "conhecimento", nome: "Conhecimento", atributo: "Ideia", desc: "Cultura geral e ciências.", origem: "academico" },
      { id: "investigacao", nome: "Investigação", atributo: "Ideia", desc: "Analisar cenas de crime.", origem: "investigador" },
      { id: "percepcao", nome: "Percepção", atributo: "Ideia", desc: "Notar detalhes e perigos.", origem: "investigador" },
      { id: "luta", nome: "Luta", atributo: "Força", desc: "Combate corpo-a-corpo.", origem: "militar" },
      { id: "tatica", nome: "Tática", atributo: "Ideia", desc: "Estratégia de combate.", origem: "militar" },
      { id: "persuasao", nome: "Persuasão", atributo: "Carisma", desc: "Convencer e negociar.", origem: "civil" },
      { id: "intuicao", nome: "Intuição", atributo: "Ideia", desc: "Sentir intenções.", origem: "civil" },
      { id: "ocultismo", nome: "Ocultismo", atributo: "Conexao", desc: "Conhecimento do paranormal.", origem: "cultista" },
      { id: "enganacao", nome: "Enganação", atributo: "Carisma", desc: "Mentir e disfarçar.", origem: "cultista" },
      // Gerais (Origem null)
      { id: "atletismo", nome: "Atletismo", atributo: "Força", desc: "Correr, pular, escalar.", origem: null },
      { id: "sobrevivencia", nome: "Sobrevivência", atributo: "Resistência", desc: "Rastrear e resistir ao ambiente.", origem: null },
      { id: "vontade", nome: "Vontade", atributo: "Resistência", desc: "Resistência mental.", origem: null },
      { id: "diplomacia", nome: "Diplomacia", atributo: "Carisma", desc: "Etiqueta e acordos.", origem: null },
      { id: "furtividade", nome: "Furtividade", atributo: "Destreza", desc: "Mover-se sem ser visto.", origem: null },
      { id: "pontaria", nome: "Pontaria", atributo: "Destreza", desc: "Armas de fogo e arremesso.", origem: null },
      { id: "medicina", nome: "Medicina", atributo: "Ideia", desc: "Primeiros socorros.", origem: null },
      { id: "tecnologia", nome: "Tecnologia", atributo: "Ideia", desc: "Computadores e dispositivos.", origem: null },
    ]
  },

  // Estado da Aplicação
  state: {
    data: null, // Dados do localStorage
    selecionadas: new Set(),
    automaticas: new Set(),
    pontosTotais: 0,
    pontosGastos: 0
  },

  // Inicialização
  init() {
    this.carregarDados();
    this.cacheDom();
    this.bindEvents();
    
    if (this.state.data) {
      this.renderHeader();
      this.calcularAtributos();
      this.calcularLogicaPericias();
      this.renderListaPericias();
      this.updateUI();
    }
  },

  // Cache de Elementos DOM
  cacheDom() {
    this.dom = {
      gridAtributos: document.getElementById('gridAtributos'),
      listaPericias: document.getElementById('listaPericias'),
      displayPontos: document.getElementById('displayPontos'),
      progressBar: document.getElementById('progressBar'),
      feedback: document.getElementById('feedbackMsg'),
      pv: document.getElementById('pv'),
      san: document.getElementById('san'),
      pe: document.getElementById('pe'),
      btnSalvar: document.getElementById('btnSalvar'),
      btnVoltar: document.getElementById('btnVoltar')
    };
  },

  // Event Listeners
  bindEvents() {
    this.dom.btnVoltar.addEventListener('click', () => {
      if(confirm("Deseja voltar para a criação? As alterações não salvas serão perdidas.")) {
        window.location.href = "criacao_personagem.html"; // Ajuste o link se precisar
      }
    });

    this.dom.btnSalvar.addEventListener('click', () => this.salvarFinal());
  },

  carregarDados() {
    try {
      const raw = localStorage.getItem("personagemRPG");
      if (!raw) throw new Error("Sem dados");
      this.state.data = JSON.parse(raw);
    } catch (e) {
      alert("Erro: Nenhum personagem encontrado. Redirecionando...");
      // window.location.href = "index.html"; // Descomente em produção
      
      // MOCK PARA TESTE (Caso abra o arquivo direto sem passar pela criação)
      this.state.data = {
        nome: "Agente Teste", origem: "investigador", classe: "Especialista", nivel: 2,
        forca: 1, resistencia: 2, carisma: 1, ideia: 3, destreza: 2, conexao: 1,
        forcaTotal: 1, resistenciaTotal: 2, carismaTotal: 1, ideiaTotal: 4, destrezaTotal: 2, conexaoTotal: 1,
        periciasExtras: [] 
      };
    }
  },

  renderHeader() {
    const d = this.state.data;
    document.getElementById('viewNome').textContent = d.nome;
    document.getElementById('viewOrigem').textContent = this.capitalize(d.origem);
    document.getElementById('viewClasse').textContent = d.classe;
    document.getElementById('viewNivel').textContent = d.nivel;
  },

  capitalize(str) {
    if(!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  },

  calcularAtributos() {
    this.dom.gridAtributos.innerHTML = '';
    const d = this.state.data;

    // Renderiza inputs dos atributos
    this.config.atributos.forEach(attr => {
      const base = parseInt(d[attr] || 0);
      const total = parseInt(d[attr + 'Total'] || base);
      const bonus = total - base;

      const html = `
        <div class="stat-card">
          <label class="stat-label">${this.capitalize(attr)}</label>
          <span class="stat-detail">Base: ${base} | Bônus: ${bonus}</span>
          <input type="number" value="${total}" readonly>
        </div>
      `;
      this.dom.gridAtributos.insertAdjacentHTML('beforeend', html);
    });

    // Calcula Derivados (Fórmulas do seu sistema)
    // PV = 10 + (Força + Resistência × 2)
    // SAN = 5 + (Conexão + Ideia × 2)
    // PE = 5 + Resistência + Conexão
    const forca = d.forcaTotal || 0;
    const res = d.resistenciaTotal || 0;
    const ideia = d.ideiaTotal || 0;
    const conexao = d.conexaoTotal || 0;

    this.dom.pv.value = 10 + (forca + (res * 2));
    this.dom.san.value = 5 + (conexao + (ideia * 2));
    this.dom.pe.value = 5 + res + conexao;
  },

  calcularLogicaPericias() {
    const d = this.state.data;
    const nivel = parseInt(d.nivel || 1);

    // 1. Identificar Automáticas da Origem
    this.config.pericias.forEach(p => {
      if (p.origem === d.origem) {
        this.state.automaticas.add(p.id);
        this.state.selecionadas.add(p.id);
      }
    });

    // 2. Recuperar pericias já salvas (se houver edição)
    if (d.periciasExtras) {
      d.periciasExtras.forEach(nomeOuId => {
        // Tenta achar pelo nome ou ID
        const pObj = this.config.pericias.find(p => p.nome === nomeOuId || p.id === nomeOuId);
        if (pObj && !this.state.automaticas.has(pObj.id)) {
          this.state.selecionadas.add(pObj.id);
        }
      });
    }

    // 3. Calcular Limites
    const ptsBase = this.config.pontosBase;
    const ptsOrigem = this.config.pontosOrigem;
    const ptsNivel = Math.floor((nivel - 1) / this.config.divisorNivel);
    
    this.state.pontosTotais = ptsBase + ptsOrigem + ptsNivel;

    // Atualiza Texto da UI
    document.getElementById('txtBase').textContent = ptsBase;
    document.getElementById('txtOrigem').textContent = ptsOrigem;
    document.getElementById('txtNivel').textContent = ptsNivel;

    this.recalcGastos();
  },

  recalcGastos() {
    // Gastos = Total Selecionado - Automaticas
    let count = 0;
    this.state.selecionadas.forEach(id => {
      if (!this.state.automaticas.has(id)) count++;
    });
    this.state.pontosGastos = count;
  },

  togglePericia(id) {
    const feedback = this.dom.feedback;
    feedback.classList.remove('visible'); // Reset anim

    if (this.state.selecionadas.has(id)) {
      // Remover
      this.state.selecionadas.delete(id);
    } else {
      // Adicionar (Verificar limite)
      const disponiveis = this.state.pontosTotais - this.state.pontosGastos;
      if (disponiveis <= 0) {
        feedback.textContent = "LIMITE DE PONTOS ATINGIDO!";
        feedback.classList.add('visible');
        return; // Sai sem adicionar
      }
      this.state.selecionadas.add(id);
    }
    
    this.recalcGastos();
    this.renderListaPericias(); // Re-renderiza para atualizar visual dos checkboxes
    this.updateUI();
  },

  updateUI() {
    const disponiveis = this.state.pontosTotais - this.state.pontosGastos;
    this.dom.displayPontos.textContent = disponiveis;

    // Barra de progresso
    const porcentagem = (this.state.pontosGastos / this.state.pontosTotais) * 100;
    this.dom.progressBar.style.width = `${porcentagem}%`;
    
    if (porcentagem >= 100) {
      this.dom.progressBar.classList.add('full');
    } else {
      this.dom.progressBar.classList.remove('full');
    }
  },

  renderListaPericias() {
    const container = this.dom.listaPericias;
    container.innerHTML = '';
    const origemChar = this.state.data.origem;

    // Separar em grupos para renderização organizada
    const automaticas = [];
    const gerais = [];
    const bloqueadas = [];

    this.config.pericias.forEach(p => {
      if (p.origem === origemChar) automaticas.push(p);
      else if (p.origem === null) gerais.push(p);
      else bloqueadas.push(p);
    });

    const renderItem = (p, type) => {
      const isAuto = type === 'auto';
      const isLocked = type === 'locked';
      const isSelected = this.state.selecionadas.has(p.id);
      
      let cssClass = 'pericia-item';
      if (isAuto) cssClass += ' automatic';
      if (isSelected && !isAuto) cssClass += ' selected';
      if (isLocked) cssClass += ' locked';

      const checkState = isSelected ? 'checked' : '';
      const checkClass = isAuto ? 'custom-cb auto' : `custom-cb ${checkState}`;
      const checkSymbol = isAuto ? '★' : (isSelected ? '✓' : '');

      const div = document.createElement('div');
      div.className = cssClass;
      div.innerHTML = `
        <div class="pericia-content">
          <span class="p-name">${p.nome}</span>
          <span class="p-attr">${p.atributo}</span>
          <small class="p-desc">${p.desc}</small>
        </div>
        <div class="checkbox-wrapper">
           ${isAuto ? '<small style="color:var(--accent-color)">AUTO</small>' : ''}
           ${isLocked ? '<small>Bloqueado</small>' : ''}
           <div class="${checkClass}">${checkSymbol}</div>
        </div>
      `;

      if (!isLocked && !isAuto) {
        div.addEventListener('click', () => this.togglePericia(p.id));
        div.style.cursor = 'pointer';
      }

      container.appendChild(div);
    };

    // 1. Renderizar Automáticas
    if(automaticas.length) {
      container.innerHTML += `<h3 style="padding:10px; color:var(--accent-color); font-size:0.9rem;">Da Origem (${this.capitalize(origemChar)})</h3>`;
      automaticas.forEach(p => renderItem(p, 'auto'));
    }

    // 2. Renderizar Gerais
    container.innerHTML += `<h3 style="padding:10px; color:var(--secondary-color); font-size:0.9rem; margin-top:10px;">Gerais</h3>`;
    gerais.forEach(p => renderItem(p, 'geral'));

    // 3. Renderizar Bloqueadas (opcional, se quiser esconder, só apagar esse bloco)
    if(bloqueadas.length) {
      container.innerHTML += `<h3 style="padding:10px; color:#555; font-size:0.9rem; margin-top:10px;">Outras Origens (Indisponível)</h3>`;
      bloqueadas.forEach(p => renderItem(p, 'locked'));
    }
  },

  salvarFinal() {
    // Validação final (opcional: exigir gastar tudo?)
    // if (this.state.pontosGastos < this.state.pontosTotais) ...

    const d = this.state.data;
    
    // Atualiza derivados no objeto
    d.vidaMaxima = parseInt(this.dom.pv.value);
    d.sanidadeMaxima = parseInt(this.dom.san.value);
    d.pontosEsforco = parseInt(this.dom.pe.value);
    
    // Salva listas de nomes (para compatibilidade com JSON antigo)
    const listaExtras = [];
    const listaAuto = [];
    
    this.state.selecionadas.forEach(id => {
      const p = this.config.pericias.find(x => x.id === id);
      if (this.state.automaticas.has(id)) listaAuto.push(p.nome);
      else listaExtras.push(p.nome);
    });

    d.periciasExtras = listaExtras;
    d.periciasAutomaticas = listaAuto;
    d.periciasTodas = [...listaAuto, ...listaExtras];

    // Salva no LocalStorage
    localStorage.setItem("personagemRPG", JSON.stringify(d));
    
    // Atualiza lista de fichas (se existir esse sistema)
    try {
      const fichas = JSON.parse(localStorage.getItem("fichasRPG")) || [];
      const idx = fichas.findIndex(f => f.nome === d.nome);
      if (idx !== -1) {
        fichas[idx] = d;
      } else {
        fichas.push(d);
      }
      localStorage.setItem("fichasRPG", JSON.stringify(fichas));
    } catch(e) { console.log("Sistema de lista de fichas não detectado."); }

    alert("Personagem salvo com sucesso!");
    window.location.href = "ficha-final.html"; // Redirecionamento
  }
};

// Iniciar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});
</script>

</body>
</html>
